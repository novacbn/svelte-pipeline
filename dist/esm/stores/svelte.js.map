{
  "version": 3,
  "sources": ["src/stores/svelte.ts"],
  "sourcesContent": ["import * as svelte from \"svelte\";\nimport type {SvelteComponent} from \"svelte\";\nimport type {CompileOptions} from \"svelte/types/compiler/interfaces\";\n\nimport {compile} from \"svelte/compiler\";\nimport * as svelte_internal from \"svelte/internal\";\n\nimport * as svelte_store from \"svelte/store\";\n\nimport type {\n    IPipelineContext,\n    IPipelineError,\n    IPipelineImports,\n    IPipelineModule,\n    IPipelineEvaluated,\n    IPipelineStore,\n    IPipelineOptions,\n    IPipelineValidated,\n} from \"./pipeline\";\n\nimport {\n    PIPELINE_MODES,\n    PIPELINE_RESULT_TYPES,\n    evaluate_code,\n    make_require,\n    validate_code,\n} from \"./pipeline\";\n\nimport {PIPELINE_JAVASCRIPT_CONTEXT, PIPELINE_JAVASCRIPT_IMPORTS} from \"./javascript\";\n\nconst {\n    onDestroy,\n    onMount,\n    afterUpdate,\n    beforeUpdate,\n    createEventDispatcher,\n    getContext,\n    setContext,\n    tick,\n} = svelte;\n\nconst {derived, readable, writable} = svelte_store;\n\ntype ISvelteExport = {[key: string]: any; default: SvelteComponent};\n\nexport interface IPipelineSvelteModule extends IPipelineModule<ISvelteExport> {}\n\nexport interface IPipelineSvelteOptions extends IPipelineOptions {\n    compiler: CompileOptions;\n}\n\nexport interface IPipelineSvelteEvaluated extends IPipelineEvaluated<ISvelteExport> {\n    stylesheet: string;\n}\n\nexport interface IPipelineSvelteStore extends IPipelineStore<ISvelteExport> {}\n\nconst PIPELINE_SVELTE_CONTEXT: IPipelineContext = {\n    ...PIPELINE_JAVASCRIPT_CONTEXT,\n    onMount,\n    onDestroy,\n    createEventDispatcher,\n    afterUpdate,\n    beforeUpdate,\n    derived,\n    getContext,\n    readable,\n    setContext,\n    tick,\n    writable,\n};\n\nconst PIPELINE_SVELTE_IMPORTS: IPipelineImports = {\n    ...PIPELINE_JAVASCRIPT_IMPORTS,\n    svelte: svelte,\n    \"svelte/internal\": svelte_internal,\n    \"svelte/store\": svelte_store,\n};\n\n// TODO: meh, repeated code\nfunction PipelineSvelteOptions(\n    options: Partial<IPipelineSvelteOptions> = {}\n): IPipelineSvelteOptions {\n    const {compiler = {}, context = {}, imports = {}, mode = PIPELINE_MODES.evaluate} = options;\n    const require = make_require({...PIPELINE_SVELTE_IMPORTS, ...imports});\n\n    return {\n        mode,\n        imports: {},\n        compiler: {\n            ...compiler,\n            css: false,\n            format: \"cjs\",\n        },\n\n        context: {\n            ...PIPELINE_SVELTE_CONTEXT,\n            ...context,\n            require,\n        },\n    };\n}\n\nexport function validate_svelte(script: string): [boolean, string?] {\n    try {\n        compile(script, {\n            css: false,\n            format: \"cjs\",\n            generate: false,\n        });\n    } catch (err) {\n        return [false, err.message];\n    }\n\n    return [true];\n}\n\nexport function pipeline_svelte(options?: Partial<IPipelineSvelteOptions>): IPipelineSvelteStore {\n    const {compiler, context, mode} = PipelineSvelteOptions(options);\n    const writable_store = writable<string>(\"\");\n\n    const derived_store = derived(writable_store, (script: string) => {\n        if (!script) return null;\n\n        // TODO: Return warnings\n        let [validated, message] = validate_svelte(script);\n\n        if (!validated) return {message, type: PIPELINE_RESULT_TYPES.error} as IPipelineError;\n        if (mode === PIPELINE_MODES.validate) {\n            return {type: PIPELINE_RESULT_TYPES.validated} as IPipelineValidated;\n        }\n\n        const {css, js} = compile(script, compiler);\n\n        [validated, message] = validate_code(js.code);\n        if (!validated) return {message, type: PIPELINE_RESULT_TYPES.error} as IPipelineError;\n\n        const [evaluated, module] = evaluate_code(js.code, context);\n        if (!evaluated) {\n            return {message: module, type: PIPELINE_RESULT_TYPES.error} as IPipelineError;\n        }\n\n        return {\n            module,\n            stylesheet: css.code,\n            type: PIPELINE_RESULT_TYPES.evaluated,\n        } as IPipelineSvelteEvaluated;\n    });\n\n    return {\n        set: writable_store.set,\n        subscribe: derived_store.subscribe,\n        update: writable_store.update,\n    };\n}\n"],
  "mappings": "AAAA;AAIA;AACA;AAEA;AAaA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQA;AAEA,MAAM;AAAA,EACF;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,IACA;AAEJ,MAAM,CAAC,SAAS,UAAU,YAAY;AAgBtC,MAAM,0BAA4C;AAAA,KAC3C;AAAA,EACH;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA;AAGJ,MAAM,0BAA4C;AAAA,KAC3C;AAAA,EACH;AAAA,EACA,mBAAmB;AAAA,EACnB,gBAAgB;AAAA;AAIpB,+BACI,UAA2C;AAE3C,QAAM,CAAC,sBAAW,IAAI,UAAU,IAAI,UAAU,IAAI,OAAO,eAAe,YAAY;AACpF,QAAM,WAAU,aAAa,IAAI,4BAA4B;AAE7D,SAAO;AAAA,IACH;AAAA,IACA,SAAS;AAAA,IACT,UAAU;AAAA,SACH;AAAA,MACH,KAAK;AAAA,MACL,QAAQ;AAAA;AAAA,IAGZ,SAAS;AAAA,SACF;AAAA,SACA;AAAA,MACH;AAAA;AAAA;AAAA;AAKL,yBAAyB;AAC5B;AACI,YAAQ,QAAQ;AAAA,MACZ,KAAK;AAAA,MACL,QAAQ;AAAA,MACR,UAAU;AAAA;AAAA,WAET;AACL,WAAO,CAAC,OAAO,IAAI;AAAA;AAGvB,SAAO,CAAC;AAAA;AAGL,yBAAyB;AAC5B,QAAM,CAAC,qBAAU,SAAS,QAAQ,sBAAsB;AACxD,QAAM,iBAAiB,SAAiB;AAExC,QAAM,gBAAgB,QAAQ,gBAAgB,CAAC;AAC3C,QAAI,CAAC;AAAQ,aAAO;AAGpB,QAAI,CAAC,WAAW,WAAW,gBAAgB;AAE3C,QAAI,CAAC;AAAW,aAAO,CAAC,SAAS,MAAM,sBAAsB;AAC7D,QAAI,SAAS,eAAe;AACxB,aAAO,CAAC,MAAM,sBAAsB;AAAA;AAGxC,UAAM,CAAC,KAAK,MAAM,QAAQ,QAAQ;AAElC,KAAC,WAAW,WAAW,cAAc,GAAG;AACxC,QAAI,CAAC;AAAW,aAAO,CAAC,SAAS,MAAM,sBAAsB;AAE7D,UAAM,CAAC,WAAW,UAAU,cAAc,GAAG,MAAM;AACnD,QAAI,CAAC;AACD,aAAO,CAAC,SAAS,QAAQ,MAAM,sBAAsB;AAAA;AAGzD,WAAO;AAAA,MACH;AAAA,MACA,YAAY,IAAI;AAAA,MAChB,MAAM,sBAAsB;AAAA;AAAA;AAIpC,SAAO;AAAA,IACH,KAAK,eAAe;AAAA,IACpB,WAAW,cAAc;AAAA,IACzB,QAAQ,eAAe;AAAA;AAAA;",
  "names": []
}
